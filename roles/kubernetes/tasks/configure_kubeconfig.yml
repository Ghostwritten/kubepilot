# =============================================================================
# roles/kubernetes/tasks/configure_kubeconfig.yml - Configure Kubernetes Client
# =============================================================================
---
- name: "Create .kube directory for the ansible user"
  file:
    path: "/home/{{ ansible_user }}/.kube"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  when: inventory_hostname == groups['kube_control_plane'][0]
  tags: kubeconfig

- name: "Copy admin.conf to the ansible user's .kube directory"
  copy:
    src: /etc/kubernetes/admin.conf
    dest: "/home/{{ ansible_user }}/.kube/config"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
    remote_src: yes
  when: inventory_hostname == groups['kube_control_plane'][0]
  tags: kubeconfig

- name: "Create .kube directory for the root user"
  file:
    path: /root/.kube
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: inventory_hostname == groups['kube_control_plane'][0]
  tags: kubeconfig

- name: "Copy admin.conf to the root user's .kube directory"
  copy:
    src: /etc/kubernetes/admin.conf
    dest: /root/.kube/config
    owner: root
    group: root
    mode: '0600'
    remote_src: yes
  when: inventory_hostname == groups['kube_control_plane'][0]
  tags: kubeconfig
